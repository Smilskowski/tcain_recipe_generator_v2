<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”® Isaac Bag of Crafting Recipe Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #8B5CF6 0%, #A855F7 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            background: #f8fafc;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .component-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .component-item:hover {
            border-color: #8B5CF6;
            transform: translateY(-2px);
        }

        .component-item.selected {
            background: #8B5CF6;
            color: white;
            border-color: #7C3AED;
        }

        .component-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .component-item label {
            cursor: pointer;
            font-weight: 500;
            flex: 1;
        }

        .generate-btn {
            background: linear-gradient(135deg, #8B5CF6 0%, #A855F7 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            margin-top: 30px;
        }

        .results-header {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .results-header h3 {
            color: #374151;
            margin-bottom: 10px;
        }

        .results-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .recipes-list {
            display: grid;
            gap: 15px;
        }

        .recipe-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            transition: border-color 0.3s;
        }

        .recipe-item:hover {
            border-color: #8B5CF6;
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .recipe-number {
            background: #8B5CF6;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .recipe-weight {
            background: #f1f5f9;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .recipe-components {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .component-tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .error {
            background: #fef2f2;
            border: 2px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            background: #f9fafb;
            border-radius: 10px;
        }

        .item-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }

        .item-suggestion {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }

        .item-suggestion:hover {
            background: #f8fafc;
        }

        .item-suggestion:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 600;
            color: #374151;
        }

        .item-id {
            font-size: 0.9em;
            color: #6b7280;
            margin-left: 10px;
        }

        .input-group {
            position: relative;
        }

        @media (max-width: 768px) {
            .components-grid {
                grid-template-columns: 1fr;
            }
            
            .results-stats {
                flex-direction: column;
            }
            
            .recipe-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”® Isaac Bag of Crafting</h1>
            <p>Recipe Generator mit Seed und Komponenten-Auswahl</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <div class="input-group">
                    <label for="seed">Seed (optional):</label>
                    <input type="text" id="seed" placeholder="z.B. 12345 oder leer lassen fÃ¼r zufÃ¤llig">
                </div>
                
                <div class="input-group">
                    <label for="targetItem">Ziel-Item (ID oder Name):</label>
                    <input type="text" id="targetItem" placeholder="z.B. 161 oder 'Magic Mushroom'" autocomplete="off">
                    <div id="itemSuggestions" class="item-suggestions" style="display: none;"></div>
                </div>
                
                <div class="input-group">
                    <label>VerfÃ¼gbare Komponenten (mindestens eine auswÃ¤hlen):</label>
                    <div class="components-grid" id="componentsGrid">
                        <!-- Components will be loaded here -->
                    </div>
                </div>
                
                <button class="generate-btn" id="generateBtn" onclick="generateRecipes()">
                    ðŸ”® Rezepte generieren
                </button>
            </div>
            
            <div class="results-section" id="resultsSection" style="display: none;">
                <div class="results-header">
                    <h3>Gefundene Rezepte</h3>
                    <div class="results-stats" id="resultsStats">
                        <!-- Stats will be loaded here -->
                    </div>
                </div>
                <div class="recipes-list" id="recipesList">
                    <!-- Recipes will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Component data
        const COMPONENT_NAMES = [
            'Red Heart', 'Soul Heart', 'Black Heart', 'Eternal Heart', 'Gold Heart', 'Bone Heart',
            'Rotten Heart', 'Penny', 'Nickel', 'Dime', 'Lucky Penny', 'Key', 'Golden Key',
            'Charged Key', 'Bomb', 'Golden Bomb', 'Giga Bomb', 'Micro Battery', 'Mega Battery',
            'Card', 'Pill', 'Rune', 'Dice Shard', 'Cracked Key', 'Gold Penny', 'Golden Penny'
        ];

        const COMPONENT_WEIGHTS = [
            0, 1, 4, 5, 5, 5, 5, 1, 1, 3, 5, 8, 2, 5, 5, 2, 6, 10, 2, 4, 8, 2, 2, 4, 4, 2
        ];

        // Initialize component checkboxes
        function initializeComponents() {
            const grid = document.getElementById('componentsGrid');
            grid.innerHTML = '';
            
            COMPONENT_NAMES.forEach((name, index) => {
                const item = document.createElement('div');
                item.className = 'component-item';
                item.innerHTML = `
                    <input type="checkbox" id="comp${index}" value="${index}">
                    <label for="comp${index}">${name}</label>
                `;
                
                // Add click handler for the entire item
                item.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        updateItemSelection();
                    }
                });
                
                // Add change handler for checkbox
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', updateItemSelection);
                
                grid.appendChild(item);
            });
        }

        function updateItemSelection() {
            const items = document.querySelectorAll('.component-item');
            items.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // Update generate button state
            const selectedCount = document.querySelectorAll('input[type="checkbox"]:checked').length;
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = selectedCount === 0;
        }

        function getSelectedComponents() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        function calculateWeight(components) {
            return components.reduce((sum, comp) => sum + COMPONENT_WEIGHTS[comp], 0);
        }

        function generateCombinations(arr, r) {
            const combinations = [];
            
            function backtrack(start, current) {
                if (current.length === r) {
                    combinations.push([...current]);
                    return;
                }
                
                for (let i = start; i < arr.length; i++) {
                    current.push(arr[i]);
                    backtrack(i, current); // Allow repetition
                    current.pop();
                }
            }
            
            backtrack(0, []);
            return combinations;
        }

        async function generateRecipes() {
            const selectedComponents = getSelectedComponents();
            const targetItemInput = document.getElementById('targetItem').value.trim();
            const seed = document.getElementById('seed').value;
            
            if (selectedComponents.length === 0) {
                alert('Bitte wÃ¤hle mindestens eine Komponente aus!');
                return;
            }
            
            if (!targetItemInput) {
                alert('Bitte gib eine Item-ID oder einen Item-Namen ein!');
                return;
            }
            
            // Check if input is a number (ID) or string (name)
            const targetItemId = parseInt(targetItemInput);
            const isNumeric = !isNaN(targetItemId) && targetItemId > 0;
            
            const generateBtn = document.getElementById('generateBtn');
            const resultsSection = document.getElementById('resultsSection');
            const recipesList = document.getElementById('recipesList');
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'ðŸ”„ Generiere Rezepte...';
            resultsSection.style.display = 'none';
            
            try {
                // Show loading
                recipesList.innerHTML = '<div class="loading">ðŸ”„ Generiere Rezepte... Das kann einen Moment dauern.</div>';
                resultsSection.style.display = 'block';
                
                // Call the real API
                const requestBody = {
                    components: selectedComponents,
                    maxRecipes: 20
                };
                
                if (isNumeric) {
                    requestBody.targetItemId = targetItemId;
                } else {
                    requestBody.targetItemName = targetItemInput;
                }
                
                if (seed && seed.trim()) {
                    // Keep seed as string for proper processing
                    requestBody.seed = seed.trim();
                }
                
                const response = await fetch('/api/recipes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'API Error');
                }
                
                displayResults(data.recipes, data.targetItemId, data.targetItemName, selectedComponents);
                
            } catch (error) {
                recipesList.innerHTML = `<div class="error">Fehler beim Generieren der Rezepte: ${error.message}</div>`;
                resultsSection.style.display = 'block';
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ðŸ”® Rezepte generieren';
            }
        }


        function displayResults(recipes, targetItemId, targetItemName, selectedComponents) {
            const resultsSection = document.getElementById('resultsSection');
            const recipesList = document.getElementById('recipesList');
            const resultsStats = document.getElementById('resultsStats');
            
            if (recipes.length === 0) {
                recipesList.innerHTML = `
                    <div class="no-results">
                        <h3>Keine Rezepte gefunden</h3>
                        <p>FÃ¼r "${targetItemName}" (ID: ${targetItemId}) wurden keine Rezepte mit den ausgewÃ¤hlten Komponenten gefunden.</p>
                        <p>Versuche andere Komponenten oder ein anderes Item.</p>
                    </div>
                `;
            } else {
                // Display stats
                resultsStats.innerHTML = `
                    <div class="stat">
                        <strong>${recipes.length}</strong> Rezepte gefunden
                    </div>
                    <div class="stat">
                        <strong>${selectedComponents.length}</strong> Komponenten ausgewÃ¤hlt
                    </div>
                    <div class="stat">
                        <strong>${targetItemName}</strong> (ID: ${targetItemId})
                    </div>
                `;
                
                // Display recipes
                recipesList.innerHTML = recipes.map((recipe, index) => `
                    <div class="recipe-item">
                        <div class="recipe-header">
                            <span class="recipe-number">Rezept ${index + 1}</span>
                            <span class="recipe-weight">Gewicht: ${recipe.weight}</span>
                        </div>
                        <div class="recipe-components">
                            ${recipe.components.map(comp => 
                                `<span class="component-tag">${COMPONENT_NAMES[comp]}</span>`
                            ).join('')}
                        </div>
                        ${recipe.qualityRange ? `<div style="margin-top: 10px; font-size: 0.9em; color: #6b7280;">QualitÃ¤t: ${recipe.qualityRange.min}-${recipe.qualityRange.max} | Item-QualitÃ¤t: ${recipe.itemQuality || 'N/A'}</div>` : ''}
                    </div>
                `).join('');
            }
            
            resultsSection.style.display = 'block';
        }

        // Item search functionality
        let searchTimeout;
        async function searchItems(query) {
            if (query.length < 2) {
                document.getElementById('itemSuggestions').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/items?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                const suggestions = document.getElementById('itemSuggestions');
                if (data.items && data.items.length > 0) {
                    suggestions.innerHTML = data.items.map(item => `
                        <div class="item-suggestion" onclick="selectItem(${item.id}, '${item.name}')">
                            <span class="item-name">${item.name}</span>
                            <span class="item-id">ID: ${item.id}</span>
                        </div>
                    `).join('');
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            } catch (error) {
                console.error('Error searching items:', error);
            }
        }

        function selectItem(id, name) {
            document.getElementById('targetItem').value = name;
            document.getElementById('itemSuggestions').style.display = 'none';
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeComponents();
            
            // Add item search functionality
            const targetItemInput = document.getElementById('targetItem');
            targetItemInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchItems(this.value);
                }, 300);
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#targetItem') && !e.target.closest('#itemSuggestions')) {
                    document.getElementById('itemSuggestions').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
